# Week 33: Aug 11-17, 2025

## [Week 33 - Archived from root CHANGELOG.md]

### Added
- **Enemy Radar System**: Replaced broken minimap with Panel-based enemy radar showing enemy positions within 1500 unit range, distance-based dot sizing, always visible in top-right corner
  - **JSON Configuration Migration**: Converted hardcoded @export values to JSON-based configuration in `/vibe/data/ui/radar.json` for runtime tuning
  - **Hot-reload Support**: F5 key reloads radar settings instantly for balance iteration without recompilation
  - **BalanceDB Integration**: Added UI configuration loading with proper fallback handling and schema documentation
- **Bigger arena system with camera following player**
  - **5 arena variations**: Basic (800x600), Large (2400x1800), Mega (4000x3000), Dungeon Crawler (1600x2400), Hazard Arena (2000x1500)
  - **CameraSystem.gd**: Smooth camera following with deadzone, zoom controls (mouse wheel), arena bounds clamping, screen shake on damage
  - **Improved wall collision**: Walls positioned beyond arena boundaries to fully prevent player escape
  - **Enhanced balance settings**: Increased projectile pools (2000), extended TTL (4.5s), higher spawn counts, distance-based culling
  - **Arena features**: Destructible walls, environmental hazards (lava pools, spike traps, poison clouds)
  - **Keyboard shortcuts**: 1-5 for arena switching, T for theme cycling
  - **Boundary collision tests**: Verified wall positioning, camera clamping, and viewport constraints
- **Critical bug fixes and improvements**
  - **Theme cycling**: Fixed Array[String] type error in `get_available_themes()` method
  - **Movement pause**: Player movement now properly disabled when card picker is open (game paused)
  - **Camera persistence**: Camera continues following player after level up pause/unpause cycle
  - **Pause signals**: Added proper `game_paused_changed` signal emission in RunManager
  - **Wall positioning**: Repositioned walls exactly at arena boundaries for full movement area access
- **Documentation sync and consistency improvements**
  - **DECISIONS.md**: Updated decision numbering (2C, 4A, 5A, 6A, 10A) with detailed explanations for key decisions
  - **CLAUDE.md**: Enhanced with concrete code examples, consistent cross-references to DECISIONS.md, better workflow steps
  - **CURSOR.md**: Expanded checklists with specific validation steps, clearer boundary explanations, comprehensive PR checklist
  - **ARCHITECTURE.md**: Added code examples for layers, signals, and performance patterns; consistent cross-references
  - **Cross-reference validation**: All documentation files now use consistent linking to DECISIONS.md for authoritative decision details
  - **Enhanced checklists**: Feature PR, content addition, and system implementation checklists with specific validation steps
- **Enhanced signals architecture with typed contracts and validation**
  - **PlayerState autoload** caches player position with smart 12Hz updates (10-15Hz or >12px delta)
  - **EntityId system** for typed entity references - eliminates Node coupling in cross-system communication
  - **Enhanced EventBus** with comprehensive docstrings, typed signals (damage_requested, damage_applied, entity_killed)
  - **Signals Matrix documentation** in ARCHITECTURE.md - complete signal contracts with emitter, args, cadence, pause behavior
  - **Signal contract validation test** - headless test verifies signal emissions match documented types and frequencies
  - **CI architecture enforcement** - GitHub Actions workflow prevents `get_node("../")` anti-patterns in systems
  - **WaveDirector decoupling** - replaced direct player references with PlayerState position caching
  - **DamageSystem signal flow** - damage requests/applications now flow through EventBus with EntityId payloads
  - **Proper cleanup patterns** - all systems now disconnect signals in `_exit_tree()` to prevent memory leaks
- **Data-driven balance system refactor**
  - BalanceDB autoload singleton loads all game tunables from JSON files
  - Complete externalization: combat radii, damage, ability pools, wave spawn settings, player stats
  - JSON files: `combat.json`, `abilities.json`, `waves.json`, `player.json` in `/data/balance/`
  - Hot-reload capability via `BalanceDB.balance_reloaded` signal
  - Robust fallback system maintains identical gameplay if JSON missing/corrupted
  - Systems: DamageSystem, AbilitySystem, WaveDirector, RunManager now fully data-driven
  - Comprehensive data schema documentation in `/data/README.md`
- **Hot-reload functionality for balance data**
  - Press F5 in-game to reload all `/data/balance/*.json` files without restart
  - `BalanceDB` listens for `ui_refresh` input action and triggers `balance_reloaded()` signal
  - All systems (DamageSystem, AbilitySystem, WaveDirector, XpSystem) recompute cached values on signal
  - Console feedback confirms successful reload with system-specific messages
  - Maintains deterministic behavior - RNG streams unchanged during reload
- **Data-driven XP system migration**
  - XP system now loads curves from `res://data/xp_curves.json` instead of hardcoded values
  - JSON schema supports configurable base_multiplier, exponent, and min_first_level
  - Graceful fallback to original hardcoded values if JSON loading fails
  - Maintains identical behavior: `floor(50 * pow(level, 1.5))` with min 30 for level 1
- **XP/Level system with Card Pick mechanics**
  - XP orbs spawn on enemy death with magnet collection radius
  - Level curve: `next_xp = floor(50 * pow(level, 1.5))` with min 30 for level 1
  - Combat pauses on level-up; player chooses from 3 weighted cards
  - Cards apply stat modifiers (projectile count, speed, fire rate)
  - HUD displays current level and XP progress bar
- **Player character with WASD movement**
  - Centered at arena spawn point for projectiles and XP collection
  - 220px/s movement speed with normalized diagonal movement
- **Card system with JSON-driven rewards**
  - Weighted card pool in `res://data/cards/card_pool.json`
  - Stat modifications applied to `RunManager.stats` on selection
  - Initial cards: +2 projectiles (-15% dmg), +30% speed, +20% fire rate
- **Game pause/resume functionality**
  - `RunManager.pause_game()` stops combat step emission
  - Card picker UI pauses combat until card selection
- **Fixed-step combat loop (30 Hz)** via accumulator in RunManager
  - `EventBus.combat_step(dt)` signal emitted at consistent intervals
  - Deterministic timing regardless of frame rate
- **RNG singleton with named streams** implementing Decision 6A
  - `RNG.seed_run(run_seed)` stores master seed for runs
  - `RNG.stream(name)` returns stable substreams via hash(run_seed, name)
  - Helper functions: `randf()`, `randi_range()`, etc. for common operations
  - Default seed from system time when not specified
- **Test infrastructure** for verifying deterministic RNG behavior
  - Headless test runner for Monte-Carlo simulations
  - Verification of identical sequences with same seed
  - Stream isolation testing across `crit`, `loot`, `waves`, `ai`, `craft`
- **Monte-Carlo DPS/TTK baseline simulation**
  - `balance_sims.gd` runs 10,000 headless combat simulations using actual balance data
  - Statistical analysis: DPS/TTK mean, p50/p95 percentiles, outlier detection (>3σ)
  - Deterministic results via seeded RNG streams for CI/CD regression testing
  - Baseline: DPS 4.64±0.9, TTK 0.67s, 9% outliers (seed 42, 10k trials)
  - CI-ready output format and 1-second execution time

### Changed
- **Player movement changed from arrow keys to WASD**
  - Added dedicated movement input actions: `move_left` (A), `move_right` (D), `move_up` (W), `move_down` (S)
  - Separated movement controls from UI navigation for better control scheme flexibility
  - Maintains existing 220px/s movement speed with normalized diagonal movement
- Arena now spawns projectiles from player position instead of fixed center
- Projectile spawning respects `RunManager.stats` for count, speed, and fire rate
- Enemy deaths emit `EventBus.enemy_killed(pos, xp_value)` for XP system
- RunManager now auto-seeds with `Time.get_unix_time_from_system()` when seed=0
- All RNG operations must use named streams (no direct `randi()` calls)

### Fixed
- **GDScript compilation warnings and errors resolved**
  - Fixed narrowing conversion warnings (float to int) in RunManager.gd and balance_sims.gd
  - Resolved shadowed global identifier warnings for `seed` parameter and `BalanceSims` constant
  - Fixed integer division precision loss in progress tracking
  - Corrected autoload initialization order issue causing missing balance values
  - RunManager now properly defers player stats loading until BalanceDB is ready

### Technical
- Combat systems can now subscribe to fixed-step updates for consistent DPS
- Reproducible randomness enables save/replay functionality
- Foundation for Monte-Carlo DPS/TTK simulations established
- Event-driven architecture with signals for XP, level-up, and enemy death
- Deterministic stat progression through card selection system
- Balance system successfully tested: JSON modifications (projectile_count_add: 2, fire_rate_mult: 3.0) take effect immediately
- **Arena wall system with collision boundaries**
  - WallSystem creates StaticBody2D collision walls around arena perimeter (800x600)
  - Visual wall rendering via MultiMeshInstance2D with textured segments
  - Data-driven configuration: `/data/arena/walls.json` defines arena size, wall thickness, segment size
  - Fallback brown texture when wall_segment.webp unavailable
  - Wall collision prevents entities from leaving arena bounds
- **Comprehensive arena architecture system**
  - ArenaSystem coordinates TerrainSystem, ObstacleSystem, InteractableSystem, WallSystem
  - Data-driven JSON room layouts: `/data/arena/layouts/` for arenas and rooms
  - TerrainSystem: Floor tiles and environmental surfaces with MultiMesh rendering
  - ObstacleSystem: Pillars, crates, barriers with physics collision and destruction support
  - InteractableSystem: Chests, doors, altars with activation zones and type-specific logic
  - RoomLoader: JSON-based room loading with procedural generation fallback
  - Expandable architecture: Easy addition of new object types, room transitions, arena themes
  - Example room configuration with pillars, destructible crates, loot chests, healing altars
- **TextureThemeSystem for visual asset management**
  - Multi-theme support: dungeon, cave, tech, forest with configurable color schemes
  - Hybrid asset pipeline: WebP/PNG files with procedural fallback generation
  - Smart texture loading: theme-specific → generic → procedural fallback
  - Engine-generated textures: brick walls, checkered floors, pillars, chests
  - Themed directory structure: `/assets/sprites/{type}/themes/{theme}/`
  - Easy theme switching for different arena biomes and visual styles
  - Performance-optimized texture caching with automatic cleanup
- **Arena system implementation completed**
  - Fixed final compilation errors and signal connection timing issues
  - Player positioned correctly at arena center (0,0) for proper wall visibility
  - Wall collision and visual rendering working with MultiMesh performance
  - All arena subsystems (TerrainSystem, ObstacleSystem, InteractableSystem, WallSystem) operational
  - Procedural texture generation active for walls, terrain, obstacles, and interactables
  - Data-driven JSON room loading system functional with fallback configurations
  - Comprehensive vibe-style usage documentation for expandable rogue-like development

---

*This file archived from root CHANGELOG.md on Aug 20, 2025. See `/changelogs/README.md` for the new changelog management approach.*